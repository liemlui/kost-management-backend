<%- include('../partials/header', { title }) %>
<%- include('../partials/helpers') %>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h3 mb-1">Manage Amenities — Room <span class="mono"><%= room.code %></span></h1>
    <div class="text-muted">Room ID: <%= room.id %></div>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="/admin/kost/rooms/<%= room.id %>">Back to Room</a>
    <a class="btn btn-outline-primary" href="/admin/kost/rooms/<%= room.id %>/edit">Edit Room</a>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-5">
    <div class="card p-3">
      <h2 class="h5 mb-3">Add Amenity</h2>

      <% if (!picklist || picklist.length === 0) { %>
        <div class="alert alert-light mb-0">
          <div class="fw-semibold">No available amenities to add.</div>
          <div class="text-muted small">Either all active amenities are already assigned to this room, or there are no active amenities.</div>
          <hr />
          <a class="btn btn-sm btn-outline-dark" href="/admin/kost/amenities">Manage Master Amenities</a>
        </div>
      <% } else { %>
        <form method="POST" action="/admin/kost/rooms/<%= room.id %>/amenities">
          <div class="mb-3">
            <label class="form-label">Amenity</label>
            <select name="amenity_id" class="form-select" required>
              <option value="" disabled selected>Select an amenity...</option>
              <% picklist.forEach(a => { %>
                <option value="<%= a.id %>">
                  <%= a.category %> — <%= a.name %> (<%= a.code %>)<%= a.unit_label ? ` [${a.unit_label}]` : "" %>
                </option>
              <% }) %>
            </select>
            <div class="form-text">Only active amenities not yet assigned to this room are shown.</div>
          </div>

          <div class="row g-2">
            <div class="col-4">
              <label class="form-label">Qty</label>
              <input type="number" name="qty" class="form-control" min="1" step="1" value="1" required />
            </div>
            <div class="col-8">
              <label class="form-label">Condition</label>
              <select name="condition" class="form-select">
                <option value="" selected>(none)</option>
                <option value="NEW">NEW</option>
                <option value="GOOD">GOOD</option>
                <option value="FAIR">FAIR</option>
                <option value="DAMAGED">DAMAGED</option>
                <option value="MISSING">MISSING</option>
              </select>
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label">Notes</label>
            <textarea name="notes" class="form-control" rows="3" placeholder="Optional notes (serial number, brand, etc.)"></textarea>
          </div>

          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-dark" type="submit">Add</button>
            <a class="btn btn-outline-secondary" href="/admin/kost/rooms/<%= room.id %>">Cancel</a>
          </div>
        </form>

        <hr />
        <div class="text-muted small">
          Tip: kalau amenity belum ada di master list, tambahkan dulu di <a href="/admin/kost/amenities">Master Amenities</a>.
        </div>
      <% } %>
    </div>
  </div>

  <div class="col-lg-7">
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h5 mb-0">Current Amenities</h2>
        <a class="btn btn-sm btn-outline-dark" href="/admin/kost/amenities">Master Amenities</a>
      </div>

      <% if (!roomAmenities || roomAmenities.length === 0) { %>
        <div class="text-muted">No amenities assigned to this room yet.</div>
      <% } else { %>
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle mb-0">
            <thead>
              <tr>
                <th style="width: 28%">Amenity</th>
                <th style="width: 18%">Category</th>
                <th class="text-end" style="width: 12%">Qty</th>
                <th style="width: 18%">Condition</th>
                <th style="width: 24%">Notes</th>
                <th style="width: 1%"></th>
              </tr>
            </thead>
            <tbody>
              <% roomAmenities.forEach(ra => { %>
                <tr>
                  <td>
                    <div class="fw-semibold"><%= ra.amenity_name %></div>
                    <div class="text-muted small"><span class="mono"><%= ra.amenity_code %></span><%= ra.unit_label ? ` • ${ra.unit_label}` : "" %></div>
                  </td>

                  <td><%= ra.category %></td>

                  <td class="text-end">
                    <form method="POST" action="/admin/kost/rooms/<%= room.id %>/amenities/<%= ra.id %>" class="d-flex justify-content-end gap-2">
                      <input type="number" name="qty" class="form-control form-control-sm text-end" style="max-width: 90px"
                             min="1" step="1" value="<%= ra.qty %>" required />
                  </td>

                  <td>
                      <select name="condition" class="form-select form-select-sm" style="min-width: 140px">
                        <option value="" <%= !ra.condition ? "selected" : "" %>>(none)</option>
                        <option value="NEW" <%= ra.condition === "NEW" ? "selected" : "" %>>NEW</option>
                        <option value="GOOD" <%= ra.condition === "GOOD" ? "selected" : "" %>>GOOD</option>
                        <option value="FAIR" <%= ra.condition === "FAIR" ? "selected" : "" %>>FAIR</option>
                        <option value="DAMAGED" <%= ra.condition === "DAMAGED" ? "selected" : "" %>>DAMAGED</option>
                        <option value="MISSING" <%= ra.condition === "MISSING" ? "selected" : "" %>>MISSING</option>
                      </select>

                      <div class="mt-1">
                        <% if (ra.condition) { %>
                          <span class="badge <%= amenityConditionBadgeClass(ra.condition) %>"><%= ra.condition %></span>
                        <% } else { %>
                          <span class="text-muted small">-</span>
                        <% } %>
                      </div>
                  </td>

                  <td>
                      <input type="text" name="notes" class="form-control form-control-sm"
                             value="<%= ra.notes || '' %>" placeholder="-" />
                  </td>

                  <td class="text-end">
                      <button class="btn btn-sm btn-outline-primary" type="submit">Save</button>
                    </form>

                    <form method="POST"
                          action="/admin/kost/rooms/<%= room.id %>/amenities/<%= ra.id %>/delete"
                          class="mt-1"
                          onsubmit="return confirm('Remove this amenity from the room?')">
                      <button class="btn btn-sm btn-outline-danger w-100" type="submit">Remove</button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>

        <div class="text-muted small mt-2">
          Note: Remove = delete assignment (room_amenities row).
        </div>
      <% } %>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>
