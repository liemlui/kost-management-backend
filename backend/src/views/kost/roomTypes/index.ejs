<%- include("../partials/header", { title }) %>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h3 mb-0">Room Types</h1>
  <a class="btn btn-primary" href="/admin/kost/room-types/new"
    >+ New Room Type</a>
</div>
<%
  const errs = Array.isArray(flash?.errors)
    ? flash.errors.filter(e => String(e || "").trim() !== "")
    : [];
%>

<% if (errs.length) { %>
  <div class="alert alert-danger mb-3">
    <ul class="mb-0">
      <% errs.forEach(e => { %>
        <li><%= e %></li>
      <% }) %>
    </ul>
  </div>
<% } %>

<div class="card mb-3">
  <div class="card-body">
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <span class="badge bg-dark">Total Types: <%= usage?.total_types ?? 0 %></span>
      <span class="badge bg-success">Active: <%= usage?.active_types ?? 0 %></span>
      <span class="badge bg-secondary">Inactive: <%= usage?.inactive_types ?? 0 %></span>
      <span class="badge bg-primary">Used Types: <%= usage?.used_types ?? 0 %></span>
      <span class="badge bg-warning text-dark">Unused Types: <%= usage?.unused_types ?? 0 %></span>
      <span class="badge bg-info text-dark">Total Rooms: <%= usage?.total_rooms ?? 0 %></span>
    </div>

    <% if (usage?.top_used && usage.top_used.length) { %>
      <div class="mt-3">
        <div class="fw-semibold mb-2">Top Used Room Types</div>
        <div class="d-flex flex-wrap gap-2">
          <% usage.top_used.forEach(rt => { %>
            <a class="badge bg-light text-dark text-decoration-none border"
               href="/admin/kost/rooms?room_type_id=<%= rt.id %>"
               title="View rooms">
              <%= rt.code %> (<%= Number(rt.rooms_count || 0) %>)
            </a>
          <% }) %>
        </div>
      </div>
    <% } %>
  </div>
</div>

<div class="card">
  <div class="table-responsive">
    <table class="table table-striped table-hover mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th style="width: 100px">Status</th>
          <th style="width: 80px">ID</th>
          <th style="width: 120px">Code</th>
          <th>Name</th>
          <th class="text-end" style="width: 160px">Base Price</th>
          <th class="text-end" style="width: 160px">Deposit</th>
          <th class="text-end" style="width: 100px">Rooms</th>
          
          <th style="width: 90px">AC</th>
          <th style="width: 90px">Fan</th>
          <th style="width: 110px">Capsule</th>
          <th style="width: 120px">Action</th>
        </tr>
      </thead>
      <tbody>
        <% if (!roomTypes || roomTypes.length === 0) { %>
        <tr>
          <td colspan="11" class="text-muted">No room types yet.</td>
        </tr>
        <% } %> <% (roomTypes || []).forEach(rt => { %>
        <tr>
          <td>
            <% if (rt.is_active) { %>
            <span class="badge bg-success">Active</span>
            <% } else { %>
            <span class="badge bg-secondary">Inactive</span>
            <% } %>
          </td>

          <td><%= rt.id %></td>
          <td class="fw-semibold"><%= rt.code %></td>
          <td><%= rt.name %></td>
          <td class="text-end">
            Rp <%= Number(rt.base_monthly_price||0).toLocaleString("id-ID") %>
          </td>
          <td class="text-end">
            Rp <%= Number(rt.deposit_amount||0).toLocaleString("id-ID") %>
          </td>
          <td class="text-end">
            <a
              href="/admin/kost/rooms?room_type_id=<%= rt.id %>"
              class="text-decoration-none"
              title="View rooms"
            >
              <span class="badge bg-dark"><%= Number(rt.rooms_count || 0) %></span>
            </a>
          </td>


          <td><%= rt.has_ac ? "Yes" : "No" %></td>
          <td><%= rt.has_fan ? "Yes" : "No" %></td>
          <td><%= rt.is_capsule ? "Yes" : "No" %></td>
         <td>
  <div class="d-flex gap-2">
    <a
      class="btn btn-sm btn-outline-secondary"
      href="/admin/kost/room-types/<%= rt.id %>/edit"
    >
      Edit
    </a>

    <form
      method="POST"
      action="/admin/kost/room-types/<%= rt.id %>/toggle-active"
      data-code="<%= rt.code %>"
      onsubmit="return confirm('<%= rt.is_active ? "Deactivate" : "Activate" %> room type ' + this.dataset.code + '?');"
      class="m-0"
    >
      <button
        type="submit"
        class="btn btn-sm <%= rt.is_active ? "btn-outline-danger" : "btn-outline-success" %>"
      >
        <%= rt.is_active ? "Deactivate" : "Activate" %>
      </button>
    </form>
  </div>
</td>

        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<%- include("../partials/footer") %>
