<!-- // pwe/backend/src/views/kost/billing/index.ejs -->

<%- include("../partials/header", { title }) %>

<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="h3 mb-0">Billing</h1>

  <!-- Admin tool (bukan CTA utama) -->
  <form method="POST" action="/admin/kost/billing/generate-draft" class="mb-0">
    <button class="btn btn-sm btn-outline-primary" type="submit">
      Admin Tool: Generate Draft
    </button>
  </form>
</div>

<!-- Range control (opsional, default H-10 → H+2) -->
<form method="GET" action="/admin/kost/billing" class="d-flex gap-2 align-items-center mb-3">
  <label class="form-label mb-0 text-muted">Show</label>

  <input
    type="number"
    name="future"
    class="form-control"
    style="width: 90px"
    min="1"
    value="<%= future ?? 10 %>"
  />
  <span class="text-muted">days ahead</span>

  <input
    type="number"
    name="past"
    class="form-control"
    style="width: 90px"
    min="0"
    value="<%= past ?? 2 %>"
  />
  <span class="text-muted">days back</span>

  <button class="btn btn-outline-secondary btn-sm" type="submit">Apply</button>
</form>

<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped mb-0 align-middle">
        <thead>
          <tr>
            <th>Room</th>
            <th>Tenant</th>
            <th>Due Date</th>
            <th class="text-center">H</th>
            <th>Invoice</th>
            <th>Status</th>
            <th class="text-end">Total</th>
            <th class="text-end"></th>
          </tr>
        </thead>
        <tbody>
          <% if (!rows || rows.length === 0) { %>
            <tr>
              <td colspan="8" class="text-center py-4 text-muted">
                No upcoming billing in selected range.
              </td>
            </tr>
          <% } else { %>
            <% rows.forEach(r => { %>
              <tr>
                <td class="fw-semibold"><%= r.room_code %></td>
                <td><%= r.tenant_name %></td>

                <td>
                  <%= r.next_due_date
                    ? new Date(r.next_due_date).toISOString().slice(0,10)
                    : "-" %>
                </td>

                <!-- H countdown -->
                <td class="text-center">
                  <% if (r.d_day >= 0) { %>
                    <span class="badge bg-info">H-<%= r.d_day %></span>
                  <% } else { %>
                    <span class="badge bg-danger">H+<%= Math.abs(r.d_day) %></span>
                  <% } %>
                </td>

                <!-- Invoice no -->
                <td>
                  <%= r.invoice_number || "-" %>
                </td>

                <!-- Invoice status -->
                <td>
                  <% if (!r.invoice_status) { %>
                    <span class="badge bg-secondary">NOT ISSUED</span>
                  <% } else { %>
                    <%
                      const statusClass = {
                        DRAFT: "bg-secondary",
                        ISSUED: "bg-primary",
                        PAID: "bg-success",
                        VOID: "bg-danger",
                        CANCELLED: "bg-warning text-dark"
                      }[r.invoice_status] || "bg-secondary";
                    %>
                    <span class="badge <%= statusClass %>"><%= r.invoice_status %></span>
                  <% } %>
                </td>

                <!-- Total -->
                <td class="text-end fw-semibold">
                  <% if (r.total_amount !== null && r.total_amount !== undefined) { %>
                    Rp <%= new Intl.NumberFormat("id-ID").format(Number(r.total_amount)) %>
                  <% } else { %>
                    -
                  <% } %>
                </td>

                <!-- Action -->
                <td class="text-end">
                  <% if (r.invoice_id) { %>
                    <a
                      class="btn btn-sm btn-outline-primary"
                      href="/admin/kost/billing/<%= r.invoice_id %>"
                    >
                      Detail
                    </a>
                  <% } else if (r.d_day <= 7) { %>
                    <span class="text-muted small">Waiting issue (H-7)</span>
                  <% } else { %>
                    <span class="text-muted small">—</span>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<%- include("../partials/footer") %>
