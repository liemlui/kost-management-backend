<!-- admin/kost/stays/detail.ejs -->
<%- include('../partials/header', { title }) %>

<h1 class="h3 mb-3">Stay Detail</h1>

<%
  function idr(v) {
    const n = Number(v || 0);
    const rounded = Math.round(n);
    return "Rp " + String(rounded).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }
  function dateOnly(v) {
    if (!v) return "-";
    const d = new Date(v);
    return d.toLocaleDateString("en-CA", { timeZone: "Asia/Jakarta" }); // YYYY-MM-DD
  }
    function anchorDay(stay) {
    if (stay.billing_anchor_day !== null && stay.billing_anchor_day !== undefined && stay.billing_anchor_day !== "") {
      return stay.billing_anchor_day;
    }
    if (!stay.check_in_at) return "-";
    const d = new Date(stay.check_in_at);
    return Number(d.toLocaleDateString("en-CA", { timeZone: "Asia/Jakarta", day: "2-digit" }));
  }
%>

<div class="card p-3 mb-3">
  <div class="row g-3">
    <div class="col-md-6">
      <div class="mb-2"><strong>Status:</strong> <%= stay.status %></div>
      <div class="mb-2"><strong>Tenant:</strong> <%= stay.tenant_name %> (ID: <%= stay.tenant_id %>)</div>
      <div class="mb-2"><strong>Room:</strong> <%= stay.room_code %> â€” <%= stay.room_type_code %> (<%= stay.room_type_name %>)</div>
      <div class="mb-2"><strong>Rent period:</strong> <%= stay.rent_period %></div>

      <hr/>

      <h6 class="mb-2">Contract Pricing (Snapshot)</h6>

      <div class="mb-2 d-flex justify-content-between">
        <span>Base rent</span>
        <strong><%= idr(stay.base_rent_amount) %></strong>
      </div>

      <div class="mb-2 d-flex justify-content-between">
        <span>Additional rent</span>
        <strong><%= idr(stay.additional_rent_amount) %></strong>
      </div>

      <% if (stay.additional_rent_reason) { %>
        <div class="mb-2 text-muted">
          <small><strong>Additional reason:</strong> <%= stay.additional_rent_reason %></small>
        </div>
      <% } %>

      <div class="mb-2 d-flex justify-content-between">
        <span>Discount</span>
        <strong>- <%= idr(stay.discount_amount) %></strong>
      </div>

      <% if (stay.discount_reason) { %>
        <div class="mb-2 text-muted">
          <small><strong>Discount reason:</strong> <%= stay.discount_reason %></small>
        </div>
      <% } %>

      <hr/>

      <div class="mb-2 d-flex justify-content-between">
        <span><strong>Total contract (Agreed rent)</strong></span>
        <strong class="fs-5"><%= idr(stay.agreed_rent_amount) %></strong>
      </div>

      <div class="mb-2 d-flex justify-content-between">
        <span>Deposit</span>
        <strong><%= idr(stay.deposit_amount) %></strong>
      </div>
    </div>

    <div class="col-md-6">
      <h6 class="mb-2">Dates</h6>
      <div class="mb-2"><strong>Check-in:</strong> <%= dateOnly(stay.check_in_at) %></div>
      <div class="mb-2"><strong>Planned check-out:</strong> <%= dateOnly(stay.planned_check_out_at) %></div>
      <div class="mb-2"><strong>Check-out:</strong> <%= dateOnly(stay.check_out_at) %></div>
      <div class="mb-2"><strong>Physical check-out:</strong> <%= dateOnly(stay.physical_check_out_at) %></div>
      <div class="mb-2"><strong>Billing anchor day:</strong> <%= anchorDay(stay)  %></div>

      <hr/>

      <h6 class="mb-2">Legacy Fixed Amounts (not calculated in Stay)</h6>
      <div class="mb-2"><strong>Electricity mode:</strong> <%= stay.electricity_mode %></div>
      <div class="mb-2">
        <strong>Fixed amounts:</strong>
        Elec <%= idr(stay.electricity_fixed_amount ?? 0) %>,
        Water <%= idr(stay.water_fixed_amount ?? 0) %>,
        Internet <%= idr(stay.internet_fixed_amount ?? 0) %>
      </div>

      <% if (stay.notes) { %>
        <hr/>
        <div><strong>Notes:</strong> <%= stay.notes %></div>
      <% } %>
    </div>
  </div>
</div>

<div class="d-flex gap-2">
  <a class="btn btn-outline-secondary" href="/admin/kost/stays">Back</a>

  <% if (stay.status === 'ACTIVE') { %>
    <form
      method="POST"
      action="/admin/kost/stays/<%= stay.id %>/checkout"
      onsubmit="return confirm('Checkout this stay?');"
    >
      <button class="btn btn-danger" type="submit">Checkout</button>
    </form>
  <% } %>
  <% if (!stay.physical_check_out_at) { %>
  <form
    method="POST"
    action="/admin/kost/stays/<%= stay.id %>/physical-checkout"
    onsubmit="return confirm('Mark physical check-out (tenant has moved out and returned key)?');"
  >
    <button class="btn btn-outline-primary" type="submit">Mark Physical Check-out</button>
  </form>
<% } %>
</div>



<%- include('../partials/footer') %>
